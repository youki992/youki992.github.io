<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‰çº§7 - CSPç»•è¿‡XSS</title>
    <link rel="stylesheet" href="../css/style.css">
    <!-- æ¨¡æ‹ŸCSPç­–ç•¥ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';">
</head>
<body>
    <div class="container">
        <header class="fade-in">
            <h1>ç­‰çº§7 - CSPç»•è¿‡XSS</h1>
            <p class="subtitle">ç»•è¿‡å†…å®¹å®‰å…¨ç­–ç•¥å®ç°XSSæ”»å‡»</p>
        </header>

        <div class="navigation fade-in">
            <a href="../index.html" class="btn btn-secondary">â† è¿”å›ä¸»é¡µ</a>
            <span class="level-info">éš¾åº¦: å›°éš¾ | 7/8</span>
        </div>

        <div class="challenge-area fade-in">
            <h2>æŒ‘æˆ˜æè¿°</h2>
            <p>å†…å®¹å®‰å…¨ç­–ç•¥(CSP)æ˜¯ä¸€ç§é‡è¦çš„XSSé˜²æŠ¤æœºåˆ¶ï¼Œé€šè¿‡é™åˆ¶èµ„æºåŠ è½½æ¥æºæ¥é˜²æ­¢æ¶æ„è„šæœ¬æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œä¸å½“é…ç½®çš„CSPå¯èƒ½å­˜åœ¨ç»•è¿‡æ–¹æ³•ã€‚è¿™ä¸ªæŒ‘æˆ˜æ¨¡æ‹Ÿäº†ä¸€ä¸ªé…ç½®äº†CSPä½†ä»å­˜åœ¨XSSæ¼æ´çš„åœºæ™¯ã€‚</p>
            
            <div class="alert alert-info">
                <strong>ç›®æ ‡ï¼š</strong>åœ¨CSPä¿æŠ¤ä¸‹ï¼Œæ‰¾åˆ°ç»•è¿‡æ–¹æ³•æ‰§è¡ŒJavaScriptä»£ç å¹¶å¼¹å‡ºåŒ…å«"XSS"çš„è­¦å‘Šæ¡†ã€‚
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="toggleHints()">æ˜¾ç¤ºæç¤º</button>
                <button class="btn-secondary" onclick="showSource()">æŸ¥çœ‹æºç </button>
                <button class="btn-secondary" onclick="showCSP()">æŸ¥çœ‹CSPç­–ç•¥</button>
            </div>
        </div>

        <div class="hint-box fade-in" id="hints" style="display: none;">
            <div class="hint-title">ğŸ’¡ æç¤º</div>
            <ul>
                <li>å½“å‰CSPç­–ç•¥å…è®¸'unsafe-inline'ï¼Œå¯ä»¥æ‰§è¡Œå†…è”è„šæœ¬</li>
                <li>å°è¯•ä½¿ç”¨å†…è”äº‹ä»¶å¤„ç†å™¨ï¼Œå¦‚onclickã€onloadç­‰</li>
                <li>å¯ä»¥åˆ©ç”¨ç°æœ‰çš„JavaScriptå‡½æ•°æˆ–å…¨å±€å˜é‡</li>
                <li>å°è¯•æ„é€ ä¸éœ€è¦å¤–éƒ¨èµ„æºçš„payload</li>
                <li>ç¤ºä¾‹ï¼š&lt;img src=x onerror="alert('XSS')"&gt;</li>
                <li>æˆ–è€…ï¼š&lt;svg onload="alert('XSS')"&gt;</li>
                <li>ä¹Ÿå¯ä»¥å°è¯•ï¼š&lt;details open ontoggle="alert('XSS')"&gt;</li>
                <li>åˆ©ç”¨ç°æœ‰å‡½æ•°ï¼šonclick="eval('alert(\\'XSS\\')')"</li>
            </ul>
        </div>

        <div class="challenge-area fade-in">
            <h3>CSPç­–ç•¥åˆ†æ</h3>
            <div class="code-block">
// å½“å‰CSPç­–ç•¥ï¼š
// Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; object-src 'none';

// CSPç­–ç•¥è§£æï¼š
// default-src 'self'     - é»˜è®¤åªå…è®¸åŒæºèµ„æº
// script-src 'self' 'unsafe-inline' - å…è®¸åŒæºè„šæœ¬å’Œå†…è”è„šæœ¬
// object-src 'none'      - ç¦æ­¢æ‰€æœ‰objectã€embedã€applet

// æ¼æ´åˆ†æï¼š
// 1. 'unsafe-inline'å…è®¸å†…è”JavaScriptæ‰§è¡Œ
// 2. å¯ä»¥ä½¿ç”¨äº‹ä»¶å¤„ç†å™¨å±æ€§
// 3. å¯ä»¥åˆ©ç”¨ç°æœ‰çš„JavaScriptä¸Šä¸‹æ–‡
// 4. ä¸éœ€è¦åŠ è½½å¤–éƒ¨è„šæœ¬èµ„æº

// ç»•è¿‡æ–¹æ³•ï¼š
// 1. å†…è”äº‹ä»¶å¤„ç†å™¨ï¼šonclickã€onloadã€onerrorç­‰
// 2. åˆ©ç”¨HTML5æ–°æ ‡ç­¾ï¼šdetailsã€summaryç­‰
// 3. ä½¿ç”¨ç°æœ‰çš„å…¨å±€å‡½æ•°ï¼ševalã€setTimeoutç­‰
// 4. æ•°æ®URIï¼šdata:text/html,&lt;script&gt;alert('XSS')&lt;/script&gt;
            </div>
        </div>

        <div class="challenge-area fade-in">
            <h3>æ•°æ®å±•ç¤ºæµ‹è¯•åŒºåŸŸ</h3>
            
            <div class="form-group">
                <label for="dataInput">æ•°æ®å†…å®¹ï¼š</label>
                <textarea id="dataInput" rows="3" placeholder="è¾“å…¥è¦æ˜¾ç¤ºçš„æ•°æ®..." class="payload-input">æ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ï¼</textarea>
                <button onclick="displayData()" class="btn">æ˜¾ç¤ºæ•°æ®</button>
            </div>
            
            <div class="output-area">
                <h4>æ•°æ®æ˜¾ç¤ºåŒºåŸŸï¼š</h4>
                <div class="output-box" id="dataContainer">
                    æ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ï¼
                </div>
            </div>
            
            <div class="form-group">
                <label>CSPè¿è§„æŠ¥å‘Šï¼š</label>
                <textarea id="cspReport" rows="4" readonly class="code-display" placeholder="CSPè¿è§„å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
            </div>
        </div>

        <div class="challenge-area fade-in">
            <h3>æ¨¡æ¿æ¸²æŸ“æµ‹è¯•åŒºåŸŸ</h3>
            
            <div class="form-group">
                <label for="templateInput">æ¨¡æ¿å†…å®¹ï¼š</label>
                <textarea id="templateInput" rows="4" placeholder="è¾“å…¥HTMLæ¨¡æ¿..." class="payload-input">&lt;div class="welcome"&gt;
    &lt;h3&gt;ç”¨æˆ·ä¿¡æ¯&lt;/h3&gt;
    &lt;p&gt;å§“åï¼šå¼ ä¸‰&lt;/p&gt;
    &lt;p&gt;é‚®ç®±ï¼šzhangsan@example.com&lt;/p&gt;
&lt;/div&gt;</textarea>
                <button onclick="renderTemplate()" class="btn">æ¸²æŸ“æ¨¡æ¿</button>
            </div>
            
            <div class="output-area">
                <h4>æ¨¡æ¿æ¸²æŸ“ç»“æœï¼š</h4>
                <div class="output-box" id="templateContainer">
                    <div class="welcome">
                        <h3>ç”¨æˆ·ä¿¡æ¯</h3>
                        <p>å§“åï¼šå¼ ä¸‰</p>
                        <p>é‚®ç®±ï¼šzhangsan@example.com</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <strong>CSPç»•è¿‡æŠ€å·§ï¼š</strong>
                <ul>
                    <li>åˆ©ç”¨'unsafe-inline'ï¼šå†…è”äº‹ä»¶å¤„ç†å™¨</li>
                    <li>HTML5æ–°ç‰¹æ€§ï¼šdetailsã€summaryã€dialogç­‰</li>
                    <li>åˆ©ç”¨ç°æœ‰ä¸Šä¸‹æ–‡ï¼šå…¨å±€å‡½æ•°ã€å˜é‡</li>
                    <li>æ•°æ®URIï¼šåœ¨å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨data:åè®®</li>
                    <li>JSONPï¼šåˆ©ç”¨script-src 'self'åŠ è½½åŒæºJSONP</li>
                </ul>
            </div>
        </div>

        <footer class="footer">
            <p>Â© 2024 XSSæŒ‘æˆ˜é¶åœº | ä»…ä¾›å­¦ä¹ ä½¿ç”¨</p>
        </footer>
    </div>

    <script>
        // CSPè¿è§„æŠ¥å‘Šæ”¶é›†
        let cspViolations = [];
        
        // ç›‘å¬CSPè¿è§„äº‹ä»¶
        document.addEventListener('securitypolicyviolation', function(event) {
            const violation = {
                blockedURI: event.blockedURI,
                violatedDirective: event.violatedDirective,
                originalPolicy: event.originalPolicy,
                timestamp: new Date().toLocaleString()
            };
            
            cspViolations.push(violation);
            updateCSPReport();
        });

        function updateCSPReport() {
            const report = cspViolations.map(v => 
                `[${v.timestamp}] è¿è§„æŒ‡ä»¤: ${v.violatedDirective}, è¢«é˜»æ­¢çš„URI: ${v.blockedURI}`
            ).join('\n');
            
            document.getElementById('cspReport').value = report || 'æš‚æ— CSPè¿è§„æŠ¥å‘Š';
        }

        // é‡å†™alertå‡½æ•°ä»¥æ£€æµ‹XSSæˆåŠŸ
        const originalAlert = window.alert;
        window.alert = function(message) {
            originalAlert(message);
            if (message && message.toString().toLowerCase().includes('xss')) {
                setTimeout(() => {
                    alert('ğŸ‰ æ­å–œï¼CSPç»•è¿‡XSSæ”»å‡»æˆåŠŸï¼ä½ å·²ç»æŒæ¡äº†CSPç»•è¿‡æŠ€æœ¯ï¼');
                }, 100);
            }
        };

        // CSPç»•è¿‡XSSæ¼æ´å‡½æ•°
        function displayData(data) {
            const input = data || document.getElementById('dataInput').value;
            
            // å­˜åœ¨XSSæ¼æ´ï¼šç›´æ¥ä½¿ç”¨innerHTML
            document.getElementById('dataContainer').innerHTML = input;
        }

        function renderTemplate() {
            const template = document.getElementById('templateInput').value;
            
            if (!template.trim()) {
                alert('è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
                return;
            }
            
            // å­˜åœ¨XSSæ¼æ´ï¼šç›´æ¥æ¸²æŸ“ç”¨æˆ·è¾“å…¥çš„HTML
            document.getElementById('templateContainer').innerHTML = template;
        }

        // é¡µé¢åŠŸèƒ½å‡½æ•°
        function toggleHints() {
            const hints = document.getElementById('hints');
            hints.style.display = hints.style.display === 'none' ? 'block' : 'none';
        }

        function showSource() {
            alert('æºç å·²åœ¨"CSPç­–ç•¥åˆ†æ"éƒ¨åˆ†æ˜¾ç¤ºï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„ä»£ç å—ã€‚');
        }

        function showCSP() {
            const csp = document.querySelector('meta[http-equiv="Content-Security-Policy"]').content;
            alert('å½“å‰CSPç­–ç•¥ï¼š\n' + csp);
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            // åˆå§‹åŒ–CSPæŠ¥å‘Š
            updateCSPReport();
            
            // é¡µé¢åŠ è½½åŠ¨ç”»
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'all 0.6s ease';
                    setTimeout(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });
        };

        // å›è½¦æäº¤
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                if (event.target.id === 'dataInput') {
                    displayData();
                } else if (event.target.id === 'templateInput') {
                    renderTemplate();
                }
            }
        });

        // æä¾›ä¸€äº›å…¨å±€å‡½æ•°ä¾›ç»•è¿‡ä½¿ç”¨
        window.globalEval = function(code) {
            return eval(code);
        };

        window.executeCode = function(code) {
            return new Function(code)();
        };
    </script>

    <style>
        .payload-input {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
        }

        .code-display {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            resize: vertical;
        }

        .output-area {
            margin: 20px 0;
        }

        .output-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 80px;
            word-wrap: break-word;
        }

        .welcome {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .welcome h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .welcome p {
            margin: 8px 0;
            color: #555;
        }

        textarea {
            resize: vertical;
        }

        #cspReport {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
    </style>
</body>
</html>